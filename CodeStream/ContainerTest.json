{"model": {"name": "ContainerTest", "tags": {"tag": []}, "modelVersion": "2.2", "concurrentExecutionsSupported": true, "pipelineParams": {"property": [{"additional": false, "type": "STRING", "name": "CONTAINER_HOST", "value": "192.168.100.226", "description": ""}, {"additional": false, "type": "STRING", "name": "BUILD_NUMBER", "value": "10", "description": ""}, {"additional": false, "type": "STRING", "name": "BUILD_NAME", "value": "cs-demo", "description": ""}]}, "version": 4, "stages": {"stage": [{"index": 0, "tasks": {"task": [{"index": 0, "conditionalExpression": "", "name": "GetArtifact", "plugin": {"category": "ALL", "provider": "vrcs.am:resolve"}, "outputProperties": {"property": [{"additional": false, "type": "JSON[]", "name": "ARTIFACT_OUTPUT", "value": "true", "description": "ARTIFACT_OUTPUT"}, {"additional": false, "type": "JSON[]", "name": "artifacts", "value": "true", "description": "artifacts"}]}, "continueOnFailure": false, "dependsOn": [], "inputProperties": {"property": [{"additional": false, "type": "vrcs.am:ArtifactoryServer", "name": "artifactoryServer", "value": "${racks['vrcs.am:ArtifactoryServer@Artifact226']}", "description": "artifactoryServer"}, {"additional": false, "type": "JSON[]", "name": "artifactSpecs", "value": "[{\"repository\":\"vrcs-demo\",\"searchType\":\"gavc\",\"name\":\"artifact\",\"inputParameters\":{\"groupID\":\"com.vmware.demo\",\"artifactID\":\"${pipeline.BUILD_NAME}\",\"version\":\"${pipeline.BUILD_NUMBER}\",\"classifier\":\"\"}}]", "description": "artifactSpecs"}]}}, {"index": 1, "conditionalExpression": "", "name": "Deploy Artifact", "plugin": {"category": "ALL", "provider": "vrcs.script:script"}, "outputProperties": {"property": [{"additional": false, "type": "String[]", "name": "hostList", "value": "true", "description": "hostList"}, {"additional": false, "type": "JSON[]", "name": "outputConfig", "value": "true", "description": "outputConfig"}, {"additional": false, "type": "JSON[]", "name": "hostResponse", "value": "true", "description": "hostResponse"}]}, "continueOnFailure": false, "dependsOn": ["GetArtifact"], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "scriptContent", "value": "", "description": "scriptContent"}, {"additional": false, "type": "JSON", "name": "inputConfig", "value": "{\"inputProperties\":[]}", "description": "inputConfig"}, {"additional": false, "type": "SecureString", "name": "password", "value": "", "description": "password"}, {"additional": false, "type": "String", "name": "scriptArguments", "value": "${pipeline.BUILD_NUMBER}", "description": "scriptArguments"}, {"additional": false, "type": "String", "name": "workingDirectory", "value": "", "description": "workingDirectory"}, {"additional": false, "type": "String", "name": "scriptType", "value": "Bash", "description": "scriptType"}, {"additional": false, "type": "Boolean", "name": "isUserDefinedScript", "value": "false", "description": "isUserDefinedScript"}, {"additional": false, "type": "String", "name": "scriptName", "value": "/root/copy-artifact.sh", "description": "scriptName"}, {"additional": false, "type": "JSON", "name": "hostConfig", "value": "{\"hostGroup\":\"userDefinedHost\",\"hosts\":[\"192.168.100.226\"],\"isUserDefinedHosts\":true}", "description": "hostConfig"}, {"additional": false, "type": "String", "name": "transportType", "value": "HTTPS", "description": "transportType"}, {"additional": false, "type": "String", "name": "userName", "value": "root", "description": "userName"}, {"additional": false, "type": "JSON", "name": "artifactConfig", "value": "{\"artifactsSource\":\"${Dev.GetArtifact.ARTIFACT_OUTPUT}\",\"artifacts\":[{\"logicalName\":\"url\",\"name\":\"artifact\",\"property\":\"Download URL\"}]}", "description": "artifactConfig"}]}}, {"index": 2, "conditionalExpression": "", "name": "Start Container", "plugin": {"category": "ALL", "provider": "vrcs.script:script"}, "outputProperties": {"property": [{"additional": false, "type": "String[]", "name": "hostList", "value": "true", "description": "hostList"}, {"additional": false, "type": "JSON[]", "name": "outputConfig", "value": "true", "description": "outputConfig"}, {"additional": false, "type": "JSON[]", "name": "hostResponse", "value": "true", "description": "hostResponse"}]}, "continueOnFailure": false, "dependsOn": ["Deploy Artifact"], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "scriptContent", "value": "", "description": "scriptContent"}, {"additional": false, "type": "JSON", "name": "inputConfig", "value": "{\"inputProperties\":[]}", "description": "inputConfig"}, {"additional": false, "type": "SecureString", "name": "password", "value": "", "description": "password"}, {"additional": false, "type": "String", "name": "scriptArguments", "value": "${pipeline.BUILD_NUMBER}", "description": "scriptArguments"}, {"additional": false, "type": "String", "name": "workingDirectory", "value": "", "description": "workingDirectory"}, {"additional": false, "type": "String", "name": "scriptType", "value": "Bash", "description": "scriptType"}, {"additional": false, "type": "Boolean", "name": "isUserDefinedScript", "value": "false", "description": "isUserDefinedScript"}, {"additional": false, "type": "String", "name": "scriptName", "value": "/root/container_request.py", "description": "scriptName"}, {"additional": false, "type": "JSON", "name": "hostConfig", "value": "{\"hostGroup\":\"userDefinedHost\",\"hosts\":[\"192.168.100.226\"],\"isUserDefinedHosts\":true}", "description": "hostConfig"}, {"additional": false, "type": "String", "name": "transportType", "value": "HTTPS", "description": "transportType"}, {"additional": false, "type": "String", "name": "userName", "value": "root", "description": "userName"}, {"additional": false, "type": "JSON", "name": "artifactConfig", "value": "null", "description": "artifactConfig"}]}}, {"index": 4, "conditionalExpression": "", "name": "Gating Rule", "plugin": {"category": "GATING_RULE", "provider": "vrcs.gatingrule:ui"}, "outputProperties": {"property": []}, "continueOnFailure": false, "dependsOn": ["Start Container"], "inputProperties": {"property": []}}]}, "name": "Dev"}, {"index": 1, "tasks": {"task": [{"index": 1, "conditionalExpression": "", "name": "Destroy Container", "plugin": {"category": "ALL", "provider": "vrcs.script:script"}, "outputProperties": {"property": [{"additional": false, "type": "String[]", "name": "hostList", "value": "true", "description": "hostList"}, {"additional": false, "type": "JSON[]", "name": "outputConfig", "value": "true", "description": "outputConfig"}, {"additional": false, "type": "JSON[]", "name": "hostResponse", "value": "true", "description": "hostResponse"}]}, "continueOnFailure": false, "dependsOn": [], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "scriptContent", "value": "#!/usr/bin/env python\nimport json\nimport operator\nimport os\nimport sys\nimport json\nimport urllib\nimport urllib2\nimport time\nimport ssl\n\nhostResponse = ${Dev.Start Container.hostResponse}\n\n#print hostResponse\n\nfor i in hostResponse[0]['value']:\n        if (i['name'] == \"logFileContent\"):\n                deployment = i['value']\n                \n                \nprint deployment\n\nhost=\"vra-01a.corp.local\"\nusername=\"jason@corp.local\"\ntenant=\"vsphere.local\"\npassword=\"VMware1!\"\n\ncontext = ssl._create_unverified_context()\n\nvalues = { 'username':username, 'password':password, 'tenant':tenant }\ndata = json.dumps(values)\nheaders = {'Accept':'application/json;charset=UTF-8','Content-Type':'application/json;charset=UTF-8'}\n\nreq = urllib2.Request(\"https://{0}/identity/api/tokens\".format(host),data=data,headers=headers)\n\ntry:\n        req = urllib2.urlopen(req,context=context)\nexcept urllib2.HTTPError as e:\n        print e.code\n        print e.read()\n\n\nresp=json.loads(req.read())\n\nid = resp[\"id\"]\n\ndef getUrl(url,headers):\n        req = urllib2.Request(url,headers=headers)\n\n        try:\n                req = urllib2.urlopen(req,context=context)\n        except urllib2.HTTPError as e:\n                print e.code\n                print e.read()\n\n        request=json.loads(req.read())\n        return [request]\n\ndef postUrl(url,headers,data):\n        req = urllib2.Request(url,headers=headers,data=data)\n\n        try:\n                req = urllib2.urlopen(req,context=context)\n        except urllib2.HTTPError as e:\n                print e.code\n                print e.read()\n\n        request=json.loads(req.read())\n        return [request]\n\n\nheaders = {'Accept':'application/json;charset=UTF-8','Content-Type':'application/json;charset=UTF-8', 'Authorization':\"Bearer {0}\".format(id)}\n\n#url = \"https://{0}/catalog-service/api/consumer/resources?$filter=requestNumber%20eq%20{1}\".format(host,request_number)\nurl = \"https://{0}/catalog-service/api/consumer/resources?$filter=name%20eq%20'{1}'\".format(host,deployment)\n\nrequest = getUrl(url,headers)\n\n#print json.dumps(request)\n\nrequest_id = request[0]['content'][0]['requestId']\n\ncmd=\"curl --insecure -H \\\"Accept: application/json\\\" -H \\\"Content-Type: application/json\\\" -H \\\"Authorization: Bearer {0} \\\"  https://{1}/catalog-service/api/consumer/requests/{2}/resourceViews 2> /dev/null\".format(id,host,request_id)\n\nstream = os.popen(cmd)\n\nrequest = json.loads(stream.read())\n\n#print json.dumps(request)\n\nfor c in request[\"content\"]:\n        if c[\"hasChildren\"]:\n                print \"PARENT\",c[\"resourceId\"], c[\"name\"]\n                resource_id = c[\"resourceId\"]\n        else:\n                print \"CHILD\",c[\"resourceId\"], c[\"name\"]\n\ncmd=\"curl --insecure -H \\\"Accept: application/json\\\" -H \\\"Content-Type: application/json\\\" -H \\\"Authorization: Bearer {0} \\\"  https://{1}/catalog-service/api/consumer/resources/{2} 2> /dev/null\".format(id,host,resource_id)\n\nstream = os.popen(cmd)\n\nitem = json.loads(stream.read())\n\nprint \"RESOURCE\",item['id'],item['name']\n\ntenantLabel=item['organization']['tenantLabel']\ntenantRef=item['organization']['tenantRef']\nsubtenantLabel=item['organization']['subtenantLabel']\nsubtenantRef=item['organization']['subtenantRef']\n\ncmd=\"curl --insecure -H \\\"Accept: application/json;charset=UTF-8\\\" -H \\\"Content-Type: application/json;charset=UTF-8\\\" -H \\\"Authorization: Bearer {0} \\\"  https://{1}/catalog-service/api/consumer/resources/{2}/actions 2> /dev/null\".format(id,host,resource_id)\n\nstream = os.popen(cmd)\n\nrequest = json.loads(stream.read())\n\nfor c in request['content']:\n        if c['name'] == \"Destroy\" :\n                resourceActionRef=c['id']\n\ndelete_json={\"@type\":\"ResourceActionRequest\",\"resourceRef\":{\"id\":resource_id }, \"resourceActionRef\":{\"id\":resourceActionRef}, \"organization\":{\"tenantRef\":tenantRef,\"tenantLabel\":tenantLabel,\"subtenantRef\":subtenantRef,\"subtenantLabel\":subtenantLabel },\"state\":\"SUBMITTED\", \"requestNumber\":0, \"requestData\":{\"entries\":[]}}\n\ncmd=\"curl --verbose --insecure -X POST -H \\\"Accept: application/json;charset=UTF-8\\\" -H \\\"Content-Type: application/json;charset=UTF-8\\\" -H \\\"Authorization: Bearer {0} \\\"  --data \\'{2}\\' https://{1}/catalog-service/api/consumer/requests 2> /dev/null\".format(id,host,json.dumps(delete_json))\n\nstream = os.popen(cmd)", "description": "scriptContent"}, {"additional": false, "type": "JSON", "name": "inputConfig", "value": "{\"inputProperties\":[{\"name\":\"hostResponse\",\"value\":\"${Dev.Start Container.hostResponse}\"}]}", "description": "inputConfig"}, {"additional": false, "type": "SecureString", "name": "password", "value": "", "description": "password"}, {"additional": false, "type": "String", "name": "scriptArguments", "value": "", "description": "scriptArguments"}, {"additional": false, "type": "String", "name": "workingDirectory", "value": "", "description": "workingDirectory"}, {"additional": false, "type": "String", "name": "scriptType", "value": "Bash", "description": "scriptType"}, {"additional": false, "type": "Boolean", "name": "isUserDefinedScript", "value": "true", "description": "isUserDefinedScript"}, {"additional": false, "type": "String", "name": "scriptName", "value": "", "description": "scriptName"}, {"additional": false, "type": "JSON", "name": "hostConfig", "value": "{\"hostGroup\":\"userDefinedHost\",\"hosts\":[\"192.168.100.226\"],\"isUserDefinedHosts\":true}", "description": "hostConfig"}, {"additional": false, "type": "String", "name": "transportType", "value": "HTTPS", "description": "transportType"}, {"additional": false, "type": "String", "name": "userName", "value": "root", "description": "userName"}, {"additional": false, "type": "JSON", "name": "artifactConfig", "value": "null", "description": "artifactConfig"}]}}]}, "name": "QA"}]}, "notificationList": "", "users": []}, "metadata": {"pluginInstances": {"instance": []}}}
