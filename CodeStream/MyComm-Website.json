{"model": {"name": "MyComm-Website", "tags": {"tag": []}, "modelVersion": "2.2", "concurrentExecutionsSupported": true, "pipelineParams": {"property": [{"additional": false, "type": "STRING", "name": "DESTROY_CONTAINER", "value": "True", "description": ""}, {"additional": false, "type": "STRING", "name": "CONTAINER_HOST", "value": "192.168.100.226", "description": ""}, {"additional": false, "type": "STRING", "name": "BUILD_NUMBER", "value": "11", "description": ""}, {"additional": false, "type": "STRING", "name": "BUILD_NAME", "value": "cs-demo", "description": ""}]}, "version": 25, "stages": {"stage": [{"index": 0, "tasks": {"task": [{"index": 0, "conditionalExpression": "", "name": "GetArtifact", "plugin": {"category": "ALL", "provider": "vrcs.am:resolve"}, "outputProperties": {"property": [{"additional": false, "type": "JSON[]", "name": "ARTIFACT_OUTPUT", "value": "true", "description": "ARTIFACT_OUTPUT"}, {"additional": false, "type": "JSON[]", "name": "artifacts", "value": "true", "description": "artifacts"}]}, "continueOnFailure": false, "dependsOn": [], "inputProperties": {"property": [{"additional": false, "type": "vrcs.am:ArtifactoryServer", "name": "artifactoryServer", "value": "${racks['vrcs.am:ArtifactoryServer@Artifact226']}", "description": "artifactoryServer"}, {"additional": false, "type": "JSON[]", "name": "artifactSpecs", "value": "[{\"repository\":\"vrcs-demo\",\"searchType\":\"gavc\",\"name\":\"artifact\",\"inputParameters\":{\"groupID\":\"com.vmware.demo\",\"artifactID\":\"${pipeline.BUILD_NAME}\",\"version\":\"${pipeline.BUILD_NUMBER}\",\"classifier\":\"\"}}]", "description": "artifactSpecs"}]}}, {"index": 1, "conditionalExpression": "", "name": "Deploy Artifact", "plugin": {"category": "ALL", "provider": "vrcs.script:script"}, "outputProperties": {"property": [{"additional": false, "type": "String[]", "name": "hostList", "value": "true", "description": "hostList"}, {"additional": false, "type": "JSON[]", "name": "outputConfig", "value": "true", "description": "outputConfig"}, {"additional": false, "type": "JSON[]", "name": "hostResponse", "value": "true", "description": "hostResponse"}]}, "continueOnFailure": false, "dependsOn": ["GetArtifact"], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "scriptContent", "value": "", "description": "scriptContent"}, {"additional": false, "type": "JSON", "name": "inputConfig", "value": "{\"inputProperties\":[]}", "description": "inputConfig"}, {"additional": false, "type": "SecureString", "name": "password", "value": "", "description": "password"}, {"additional": false, "type": "String", "name": "scriptArguments", "value": "${pipeline.BUILD_NUMBER}", "description": "scriptArguments"}, {"additional": false, "type": "String", "name": "workingDirectory", "value": "", "description": "workingDirectory"}, {"additional": false, "type": "String", "name": "scriptType", "value": "Bash", "description": "scriptType"}, {"additional": false, "type": "Boolean", "name": "isUserDefinedScript", "value": "false", "description": "isUserDefinedScript"}, {"additional": false, "type": "String", "name": "scriptName", "value": "/root/copy-artifact.sh", "description": "scriptName"}, {"additional": false, "type": "JSON", "name": "hostConfig", "value": "{\"hostGroup\":\"userDefinedHost\",\"hosts\":[\"192.168.100.226\"],\"isUserDefinedHosts\":true}", "description": "hostConfig"}, {"additional": false, "type": "String", "name": "transportType", "value": "HTTPS", "description": "transportType"}, {"additional": false, "type": "String", "name": "userName", "value": "root", "description": "userName"}, {"additional": false, "type": "JSON", "name": "artifactConfig", "value": "{\"artifactsSource\":\"${Dev.GetArtifact.ARTIFACT_OUTPUT}\",\"artifacts\":[{\"logicalName\":\"url\",\"name\":\"artifact\",\"property\":\"Download URL\"}]}", "description": "artifactConfig"}]}}, {"index": 2, "conditionalExpression": "", "name": "Start Container", "plugin": {"category": "ALL", "provider": "vrcs.script:script"}, "outputProperties": {"property": [{"additional": false, "type": "String[]", "name": "hostList", "value": "true", "description": "hostList"}, {"additional": false, "type": "JSON[]", "name": "outputConfig", "value": "true", "description": "outputConfig"}, {"additional": false, "type": "JSON[]", "name": "hostResponse", "value": "true", "description": "hostResponse"}]}, "continueOnFailure": false, "dependsOn": ["Deploy Artifact"], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "scriptContent", "value": "", "description": "scriptContent"}, {"additional": false, "type": "JSON", "name": "inputConfig", "value": "{\"inputProperties\":[]}", "description": "inputConfig"}, {"additional": false, "type": "SecureString", "name": "password", "value": "", "description": "password"}, {"additional": false, "type": "String", "name": "scriptArguments", "value": "${pipeline.BUILD_NUMBER}", "description": "scriptArguments"}, {"additional": false, "type": "String", "name": "workingDirectory", "value": "", "description": "workingDirectory"}, {"additional": false, "type": "String", "name": "scriptType", "value": "Bash", "description": "scriptType"}, {"additional": false, "type": "Boolean", "name": "isUserDefinedScript", "value": "false", "description": "isUserDefinedScript"}, {"additional": false, "type": "String", "name": "scriptName", "value": "/root/container_request.py", "description": "scriptName"}, {"additional": false, "type": "JSON", "name": "hostConfig", "value": "{\"hostGroup\":\"userDefinedHost\",\"hosts\":[\"192.168.100.226\"],\"isUserDefinedHosts\":true}", "description": "hostConfig"}, {"additional": false, "type": "String", "name": "transportType", "value": "HTTPS", "description": "transportType"}, {"additional": false, "type": "String", "name": "userName", "value": "root", "description": "userName"}, {"additional": false, "type": "JSON", "name": "artifactConfig", "value": "null", "description": "artifactConfig"}]}}, {"index": 3, "conditionalExpression": "", "name": "Selenium Test", "plugin": {"category": "ALL", "provider": "vrcs.jenkins:build_job"}, "outputProperties": {"property": [{"additional": false, "type": "String", "name": "jobName", "value": "true", "description": "jobName"}, {"additional": false, "type": "String", "name": "jobUrl", "value": "true", "description": "jobUrl"}, {"additional": false, "type": "String", "name": "buildId", "value": "true", "description": "buildId"}, {"additional": false, "type": "JSON", "name": "testResult", "value": "true", "description": "testResult"}, {"additional": false, "type": "String", "name": "estimatedDuration", "value": "true", "description": "estimatedDuration"}]}, "continueOnFailure": false, "dependsOn": ["Start Container"], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "jobName", "value": "jenkins-test", "description": "jobName"}, {"additional": false, "type": "JSON[]", "name": "jobParameters", "value": "[{\"name\":\"testurl\",\"value\":\"192.168.100.226\"},{\"name\":\"teststring\",\"value\":\"MyCommerce.com - Deal of the Day\"},{\"name\":\"BUILD_ID\",\"value\":\"${pipeline.BUILD_NUMBER}\"}]", "description": "jobParameters"}, {"additional": false, "type": "vrcs.jenkins:JenkinsServer", "name": "jenkinsServer", "value": "${racks['vrcs.jenkins:JenkinsServer@Jenkins']}", "description": "jenkinsServer"}]}}, {"index": 7, "conditionalExpression": "", "name": "Gating Rule", "plugin": {"category": "GATING_RULE", "provider": "vrcs.gatingrule:ui"}, "outputProperties": {"property": [{"additional": false, "type": "STRING", "name": "result", "value": "false", "description": "Result of workflow run."}, {"additional": false, "type": "STRING", "name": "message", "value": "false", "description": "Message"}]}, "continueOnFailure": false, "dependsOn": ["Selenium Test"], "inputProperties": {"property": [{"additional": false, "type": "STRING", "name": "workflowId", "value": "c3f2c726-6078-49e0-86d8-f42970df55c0", "description": ""}, {"additional": false, "type": "STRING", "name": "workflowName", "value": "Test Acceptance Threshold", "description": ""}, {"additional": false, "type": "JSON", "name": "properties", "value": "[{\"name\":\"thresholdPercentage\",\"displayName\":\"Threshold Percentage\",\"description\":\"Minimum percentage required to pass the gating rule.\",\"type\":\"number\",\"mandatory\":true,\"value\":\"100\",\"devops.model.workflowinfo_id\":\"c3f2c726-6078-49e0-86d8-f42970df55c0\"},{\"name\":\"testResponse\",\"displayName\":\"Test Result\",\"description\":\"Response of the test to calculate the threshold percentage.\",\"type\":\"string\",\"mandatory\":true,\"value\":\"${Dev.Selenium Test.testResult}\",\"devops.model.workflowinfo_id\":\"c3f2c726-6078-49e0-86d8-f42970df55c0\"}]", "description": ""}]}}]}, "name": "Dev"}, {"index": 1, "tasks": {"task": [{"index": 0, "conditionalExpression": "", "name": "Deploy QA", "plugin": {"category": "ALL", "provider": "vrcs.script:script"}, "outputProperties": {"property": [{"additional": false, "type": "String[]", "name": "hostList", "value": "true", "description": "hostList"}, {"additional": false, "type": "JSON[]", "name": "outputConfig", "value": "true", "description": "outputConfig"}, {"additional": false, "type": "JSON[]", "name": "hostResponse", "value": "true", "description": "hostResponse"}]}, "continueOnFailure": false, "dependsOn": [], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "scriptContent", "value": "", "description": "scriptContent"}, {"additional": false, "type": "JSON", "name": "inputConfig", "value": "{\"inputProperties\":[{\"name\":\"Build_ID\",\"value\":\"${pipeline.BUILD_NUMBER}\"}]}", "description": "inputConfig"}, {"additional": false, "type": "SecureString", "name": "password", "value": "", "description": "password"}, {"additional": false, "type": "String", "name": "scriptArguments", "value": "", "description": "scriptArguments"}, {"additional": false, "type": "String", "name": "workingDirectory", "value": "", "description": "workingDirectory"}, {"additional": false, "type": "String", "name": "scriptType", "value": "Bash", "description": "scriptType"}, {"additional": false, "type": "Boolean", "name": "isUserDefinedScript", "value": "false", "description": "isUserDefinedScript"}, {"additional": false, "type": "String", "name": "scriptName", "value": "/root/artifactory-install.sh", "description": "scriptName"}, {"additional": false, "type": "JSON", "name": "hostConfig", "value": "{\"hostGroup\":\"userDefinedHost\",\"hosts\":[\"web-qa.corp.local\"],\"isUserDefinedHosts\":true}", "description": "hostConfig"}, {"additional": false, "type": "String", "name": "transportType", "value": "HTTPS", "description": "transportType"}, {"additional": false, "type": "String", "name": "userName", "value": "root", "description": "userName"}, {"additional": false, "type": "JSON", "name": "artifactConfig", "value": "{\"artifactsSource\":\"${Dev.GetArtifact.ARTIFACT_OUTPUT}\",\"artifacts\":[{\"logicalName\":\"TargzFile\",\"name\":\"Artifact\",\"property\":\"Download URL\"}]}", "description": "artifactConfig"}]}}, {"index": 1, "conditionalExpression": "${pipeline.DESTROY_CONTAINER} == \"True\"", "name": "Destroy Container", "plugin": {"category": "ALL", "provider": "vrcs.script:script"}, "outputProperties": {"property": [{"additional": false, "type": "String[]", "name": "hostList", "value": "true", "description": "hostList"}, {"additional": false, "type": "JSON[]", "name": "outputConfig", "value": "true", "description": "outputConfig"}, {"additional": false, "type": "JSON[]", "name": "hostResponse", "value": "true", "description": "hostResponse"}]}, "continueOnFailure": false, "dependsOn": ["Deploy QA"], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "scriptContent", "value": "#!/usr/bin/env python\nimport json\nimport operator\nimport os\nimport sys\nimport json\nimport urllib\nimport urllib2\nimport time\nimport ssl\n\nhostResponse = ${Dev.Start Container.hostResponse}\n\n#print hostResponse\n\nfor i in hostResponse[0]['value']:\n        if (i['name'] == \"logFileContent\"):\n                deployment = i['value']\n                \n                \nprint deployment\n\nhost=\"vra-01a.corp.local\"\nusername=\"jason@corp.local\"\ntenant=\"vsphere.local\"\npassword=\"VMware1!\"\n\ncontext = ssl._create_unverified_context()\n\nvalues = { 'username':username, 'password':password, 'tenant':tenant }\ndata = json.dumps(values)\nheaders = {'Accept':'application/json;charset=UTF-8','Content-Type':'application/json;charset=UTF-8'}\n\nreq = urllib2.Request(\"https://{0}/identity/api/tokens\".format(host),data=data,headers=headers)\n\ntry:\n        req = urllib2.urlopen(req,context=context)\nexcept urllib2.HTTPError as e:\n        print e.code\n        print e.read()\n\n\nresp=json.loads(req.read())\n\nid = resp[\"id\"]\n\ndef getUrl(url,headers):\n        req = urllib2.Request(url,headers=headers)\n\n        try:\n                req = urllib2.urlopen(req,context=context)\n        except urllib2.HTTPError as e:\n                print e.code\n                print e.read()\n\n        request=json.loads(req.read())\n        return [request]\n\ndef postUrl(url,headers,data):\n        req = urllib2.Request(url,headers=headers,data=data)\n\n        try:\n                req = urllib2.urlopen(req,context=context)\n        except urllib2.HTTPError as e:\n                print e.code\n                print e.read()\n\n        request=json.loads(req.read())\n        return [request]\n\n\nheaders = {'Accept':'application/json;charset=UTF-8','Content-Type':'application/json;charset=UTF-8', 'Authorization':\"Bearer {0}\".format(id)}\n\n#url = \"https://{0}/catalog-service/api/consumer/resources?$filter=requestNumber%20eq%20{1}\".format(host,request_number)\nurl = \"https://{0}/catalog-service/api/consumer/resources?$filter=name%20eq%20'{1}'\".format(host,deployment)\n\nrequest = getUrl(url,headers)\n\n#print json.dumps(request)\n\nrequest_id = request[0]['content'][0]['requestId']\n\ncmd=\"curl --insecure -H \\\"Accept: application/json\\\" -H \\\"Content-Type: application/json\\\" -H \\\"Authorization: Bearer {0} \\\"  https://{1}/catalog-service/api/consumer/requests/{2}/resourceViews 2> /dev/null\".format(id,host,request_id)\n\nstream = os.popen(cmd)\n\nrequest = json.loads(stream.read())\n\n#print json.dumps(request)\n\nfor c in request[\"content\"]:\n        if c[\"hasChildren\"]:\n                print \"PARENT\",c[\"resourceId\"], c[\"name\"]\n                resource_id = c[\"resourceId\"]\n        else:\n                print \"CHILD\",c[\"resourceId\"], c[\"name\"]\n\ncmd=\"curl --insecure -H \\\"Accept: application/json\\\" -H \\\"Content-Type: application/json\\\" -H \\\"Authorization: Bearer {0} \\\"  https://{1}/catalog-service/api/consumer/resources/{2} 2> /dev/null\".format(id,host,resource_id)\n\nstream = os.popen(cmd)\n\nitem = json.loads(stream.read())\n\nprint \"RESOURCE\",item['id'],item['name']\n\ntenantLabel=item['organization']['tenantLabel']\ntenantRef=item['organization']['tenantRef']\nsubtenantLabel=item['organization']['subtenantLabel']\nsubtenantRef=item['organization']['subtenantRef']\n\ncmd=\"curl --insecure -H \\\"Accept: application/json;charset=UTF-8\\\" -H \\\"Content-Type: application/json;charset=UTF-8\\\" -H \\\"Authorization: Bearer {0} \\\"  https://{1}/catalog-service/api/consumer/resources/{2}/actions 2> /dev/null\".format(id,host,resource_id)\n\nstream = os.popen(cmd)\n\nrequest = json.loads(stream.read())\n\nfor c in request['content']:\n        if c['name'] == \"Destroy\" :\n                resourceActionRef=c['id']\n\ndelete_json={\"@type\":\"ResourceActionRequest\",\"resourceRef\":{\"id\":resource_id }, \"resourceActionRef\":{\"id\":resourceActionRef}, \"organization\":{\"tenantRef\":tenantRef,\"tenantLabel\":tenantLabel,\"subtenantRef\":subtenantRef,\"subtenantLabel\":subtenantLabel },\"state\":\"SUBMITTED\", \"requestNumber\":0, \"requestData\":{\"entries\":[]}}\n\ncmd=\"curl --verbose --insecure -X POST -H \\\"Accept: application/json;charset=UTF-8\\\" -H \\\"Content-Type: application/json;charset=UTF-8\\\" -H \\\"Authorization: Bearer {0} \\\"  --data \\'{2}\\' https://{1}/catalog-service/api/consumer/requests 2> /dev/null\".format(id,host,json.dumps(delete_json))\n\nstream = os.popen(cmd)", "description": "scriptContent"}, {"additional": false, "type": "JSON", "name": "inputConfig", "value": "{\"inputProperties\":[{\"name\":\"hostResponse\",\"value\":\"${Dev.Start Container.hostResponse}\"}]}", "description": "inputConfig"}, {"additional": false, "type": "SecureString", "name": "password", "value": "", "description": "password"}, {"additional": false, "type": "String", "name": "scriptArguments", "value": "", "description": "scriptArguments"}, {"additional": false, "type": "String", "name": "workingDirectory", "value": "", "description": "workingDirectory"}, {"additional": false, "type": "String", "name": "scriptType", "value": "Bash", "description": "scriptType"}, {"additional": false, "type": "Boolean", "name": "isUserDefinedScript", "value": "true", "description": "isUserDefinedScript"}, {"additional": false, "type": "String", "name": "scriptName", "value": "", "description": "scriptName"}, {"additional": false, "type": "JSON", "name": "hostConfig", "value": "{\"hostGroup\":\"userDefinedHost\",\"hosts\":[\"192.168.100.226\"],\"isUserDefinedHosts\":true}", "description": "hostConfig"}, {"additional": false, "type": "String", "name": "transportType", "value": "HTTPS", "description": "transportType"}, {"additional": false, "type": "String", "name": "userName", "value": "root", "description": "userName"}, {"additional": false, "type": "JSON", "name": "artifactConfig", "value": "null", "description": "artifactConfig"}]}}, {"index": 2, "conditionalExpression": "", "name": "Gating Rule", "plugin": {"category": "GATING_RULE", "provider": "vrcs.gatingrule:ui"}, "outputProperties": {"property": [{"additional": false, "type": "STRING", "name": "result", "value": "false", "description": "Result of workflow run."}, {"additional": false, "type": "STRING", "name": "message", "value": "false", "description": "Message"}]}, "continueOnFailure": false, "dependsOn": ["Destroy Container"], "inputProperties": {"property": [{"additional": false, "type": "STRING", "name": "workflowId", "value": "e9114f8f-c437-46af-8400-adbae2c52960", "description": ""}, {"additional": false, "type": "STRING", "name": "workflowName", "value": "Approval", "description": ""}, {"additional": false, "type": "JSON", "name": "properties", "value": "[{\"name\":\"approvalGroupDn\",\"displayName\":\"Approval Group (DN)\",\"description\":\"DN Name of the LdapGroup who can approve the release pipeline execution.\",\"type\":\"string\",\"mandatory\":true,\"value\":\"approvalgroup\",\"devops.model.workflowinfo_id\":\"e9114f8f-c437-46af-8400-adbae2c52960\"},{\"name\":\"approvalMessage\",\"displayName\":\"Approval Message\",\"description\":\"Content of the message that needs to be sent to the approver.\",\"type\":\"string\",\"mandatory\":true,\"value\":\"The execution of  ${releasePipelineName} has successfully passed through ${stageName}. Please Approve or Reject further execution of this pipeline by clicking on an appropriate button below.  Your Approval will trigger further execution of this pipeline in ${nextStageName}. If you Reject, this execution will stop at ${stageName}.  (Click \\\"Submit\\\" to Approve or \\\"Reject\\\" to Reject)\",\"devops.model.workflowinfo_id\":\"e9114f8f-c437-46af-8400-adbae2c52960\"}]", "description": ""}]}}]}, "name": "QA"}, {"index": 2, "tasks": {"task": [{"index": 0, "conditionalExpression": "", "name": "Deploy Prod", "plugin": {"category": "ALL", "provider": "vrcs.script:script"}, "outputProperties": {"property": [{"additional": false, "type": "String[]", "name": "hostList", "value": "true", "description": "hostList"}, {"additional": false, "type": "JSON[]", "name": "outputConfig", "value": "true", "description": "outputConfig"}, {"additional": false, "type": "JSON[]", "name": "hostResponse", "value": "true", "description": "hostResponse"}]}, "continueOnFailure": false, "dependsOn": [], "inputProperties": {"property": [{"additional": false, "type": "String", "name": "scriptContent", "value": "", "description": "scriptContent"}, {"additional": false, "type": "JSON", "name": "inputConfig", "value": "{\"inputProperties\":[{\"name\":\"Build_ID\",\"value\":\"${pipeline.BUILD_NUMBER}\"}]}", "description": "inputConfig"}, {"additional": false, "type": "SecureString", "name": "password", "value": "", "description": "password"}, {"additional": false, "type": "String", "name": "scriptArguments", "value": "", "description": "scriptArguments"}, {"additional": false, "type": "String", "name": "workingDirectory", "value": "", "description": "workingDirectory"}, {"additional": false, "type": "String", "name": "scriptType", "value": "Bash", "description": "scriptType"}, {"additional": false, "type": "Boolean", "name": "isUserDefinedScript", "value": "false", "description": "isUserDefinedScript"}, {"additional": false, "type": "String", "name": "scriptName", "value": "/root/artifactory-install.sh", "description": "scriptName"}, {"additional": false, "type": "JSON", "name": "hostConfig", "value": "{\"hostGroup\":\"userDefinedHost\",\"hosts\":[\"web-prod.corp.local\"],\"isUserDefinedHosts\":true}", "description": "hostConfig"}, {"additional": false, "type": "String", "name": "transportType", "value": "HTTPS", "description": "transportType"}, {"additional": false, "type": "String", "name": "userName", "value": "root", "description": "userName"}, {"additional": false, "type": "JSON", "name": "artifactConfig", "value": "{\"artifactsSource\":\"${Dev.GetArtifact.ARTIFACT_OUTPUT}\",\"artifacts\":[{\"logicalName\":\"TargzFile\",\"name\":\"Artifact\",\"property\":\"Download URL\"}]}", "description": "artifactConfig"}]}}]}, "name": "Prod"}]}, "notificationList": "", "users": []}, "metadata": {"pluginInstances": {"instance": []}}}
